language: python

python:
  - "3.6"
  - "3.7"

matrix:
  include:
    - os: "osx"
      osx_image: "xcode10"
      env: "MPI=mpich EXTRAS=--extras=mpi"
      language: "generic"
      python: 3
    - os: "osx"
      osx_image: "xcode10"
      env: "MPI=none EXTRAS="
      language: "generic"
      python: 3
      
    - os: "linux"
      env: "MPI=openmpi EXTRAS=--extras=mpi"
      language: "generic"
      python: 3
    - os: "linux"
      env: "MPI=none EXTRAS="
      language: "generic"
      python: 3

    - os: "linux"
      env: "MPI=mpich EXTRAS=--extras=mpi"
      language: "generic"
      python: 3
    - os: "linux"
      env: "MPI=none EXTRAS="
      language: "generic"
      python: 3
  
cache:
  apt: true

addons:
  apt:
    update: true
  homebrew:
    update: true
    
before_install:
  - ./bin/install-mpi.sh $MPI
  - if [[ "$MPI" == "mpich"   ]]; then mpichversion; fi
  - if [[ "$MPI" == "openmpi" ]]; then ompi_info;    fi
  - pip install poetry

install:
  - poetry install --extras=docs $EXTRAS

script:
  - sh ./bin/run_tests.sh
  - if [[ "MPI" != "none"   ]]; then for proc in 1 2; do mpiexec -n $proc poetry run python ./test/mpi/test_mpi.py; done; fi
