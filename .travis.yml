language: python

matrix:
  include:
    - os: "osx"
      osx_image: "xcode10"
      env: "MPI=mpich EXTRAS=--extras=mpi"
      language: "generic"
      python: "3.6"
    - os: "osx"
      osx_image: "xcode10"
      env: "MPI=none EXTRAS="
      language: "generic"
      python: "3.6"
      
    - os: "linux"
      env: "MPI=openmpi EXTRAS=--extras=mpi"
      language: "generic"
      python: "3.6"
    - os: "linux"
      env: "MPI=none EXTRAS="
      language: "generic"
      python: "3.6"

    - os: "linux"
      env: "MPI=mpich EXTRAS=--extras=mpi"
      language: "generic"
      python: "3.6"
    - os: "linux"
      env: "MPI=none EXTRAS="
      language: "generic"
      python: "3.6"
  
cache:
  apt: true

addons:
  apt:
    update: true
  homebrew:
    update: true
    
before_install:
  - ./bin/install-mpi.sh $MPI
  - if [[ "$MPI" == "mpich"   ]]; then mpichversion; fi
  - if [[ "$MPI" == "openmpi" ]]; then ompi_info;    fi
  - pip install poetry

install:
  - poetry install --extras=docs $EXTRAS

script:
  - sh ./bin/run_tests.sh
  - |
    if [[ "MPI" != "none"   ]]; then
        for proc in 1 2; do
            echo "Running MPI test ($MPI) with $proc processes"
            mpiexec -n $proc poetry run python3 ./test/mpi/test_mpi.py
        done
    fi
