
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Integrating existing codes &#8212; LBS 0.13.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="_static/asciinema-player_2.6.1.css" />
    <link rel="stylesheet" type="text/css" href="_static/asciinema-custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="_static/contentui.css" />
  
  <!-- So that users can add custom icons -->
  <script src="_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="_static/documentation_options.js?v=1019fba8"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/asciinema-player_2.6.1.js"></script>
    <script src="_static/contentui.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'integrating';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Basic simulation modules" href="part3.html" />
    <link rel="prev" title="Multithreading and MPI" href="mpi.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">LBS 0.13.0 documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="part1.html">
    Introduction
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="part2.html">
    Structure of the framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="part3.html">
    Basic simulation modules
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="part4.html">
    Systematic effects
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="part5.html">
    Data-reduction modules
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="part6.html">
    Tutorials
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="appendix.html">
    Appendices
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="installation.html">
    Installation
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="part1.html">
    Introduction
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="part2.html">
    Structure of the framework
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="part3.html">
    Basic simulation modules
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="part4.html">
    Systematic effects
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="part5.html">
    Data-reduction modules
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="part6.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="appendix.html">
    Appendices
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="installation.html">
    Installation
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="simulations.html">Simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="imo.html">The IMo</a></li>
<li class="toctree-l1"><a class="reference internal" href="detectors.html">Detectors, channels, and instruments</a></li>
<li class="toctree-l1"><a class="reference internal" href="plot_fp.html">Focal plane visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="observations.html">Observations</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_layout.html">Data layout</a></li>
<li class="toctree-l1"><a class="reference internal" href="profiling.html">Profiling</a></li>
<li class="toctree-l1"><a class="reference internal" href="reports.html">Creating reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="random_numbers.html">Random numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="mpi.html">Multithreading and MPI</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Integrating existing codes</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="part2.html" class="nav-link">Structure of the framework</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Integrating existing codes</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="integrating-existing-codes">
<h1>Integrating existing codes<a class="headerlink" href="#integrating-existing-codes" title="Link to this heading">#</a></h1>
<p>In this section, we provide details about how to integrate existing
codes in the LiteBIRD Simulation Framework, be they general-purpose
libraries or modules specifically developed for LiteBIRD.</p>
<section id="what-kind-of-codes-can-be-integrated">
<h2>What kind of codes can be integrated<a class="headerlink" href="#what-kind-of-codes-can-be-integrated" title="Link to this heading">#</a></h2>
<p>The LiteBIRD simulation framework provides a set of tools to simulate
the stages of data acquisition of the instrument onboard the
spacecraft. Therefore, any code that helps in producing synthetic
sample output can be integrated in the framework, in principle.
Examples of codes are:</p>
<ol class="arabic simple">
<li><p>Simulation of ADC non-linearities;</p></li>
<li><p>Injection of gain drifts;</p></li>
<li><p>Convolution of the sky signal with beam functions;</p></li>
<li><p>Generation of noise;</p></li>
<li><p>Et cetera.</p></li>
</ol>
<p>Data <em>analysis</em> codes (in opposition to <em>simulation</em> codes producing
synthetic data) can be integrated, provided that they help in
producing larger simulations for the kind of analysis done by the
Joint Study Groups (JSGs). This means that the following codes can be
integrated, even if the are analysis codes rather than simulation
codes:</p>
<ol class="arabic simple">
<li><p>Map-making;</p></li>
<li><p>Component separation;</p></li>
<li><p>Etc.</p></li>
</ol>
<p>If you plan to import a general-purpose library, the code should be
available as Python modules that can be installed using <code class="docutils literal notranslate"><span class="pre">pip</span></code>;
therefore, they should be available on the <a class="reference external" href="https://pypi.org/">Python Package Index</a>. On the other hand, if the code you want to
integrate is specific to LiteBIRD, it can probably be integrated
directly into the <cite>litebird_sim</cite> codebase.</p>
</section>
<section id="how-to-integrate-codes">
<h2>How to integrate codes<a class="headerlink" href="#how-to-integrate-codes" title="Link to this heading">#</a></h2>
<p>General-purpose libraries that are installable using <code class="docutils literal notranslate"><span class="pre">pip</span></code> should
not be copied in the <cite>litebird_sim</cite> repository, unless there is some
strong reason to do so; instead, the library should be added to the
list of dependencies using the command <code class="docutils literal notranslate"><span class="pre">poetry</span> <span class="pre">add</span> <span class="pre">LIBRARY_NAME</span></code>. If
the library is specific to LiteBIRD, it is probably better to import
it into the repository <a class="github reference external" href="https://github.com/litebird/litebird_sim">litebird/litebird_sim</a>.</p>
<p>Once the code is available, either as a dependency or as some code in
the repository, the author must implement a class that wraps the
functionality of the library and accesses input/output parameters
through the <a class="reference internal" href="simulations.html#litebird_sim.simulations.Simulation" title="litebird_sim.simulations.Simulation"><code class="xref py py-class docutils literal notranslate"><span class="pre">Simulation</span></code></a> class. Writing this wrapper ensures
the following properties:</p>
<ol class="arabic simple">
<li><p>Input parameters can be easily read from the IMO;</p></li>
<li><p>Output files are saved in the directory specified by the user for
the simulation;</p></li>
<li><p>The wrapper can provide functions to write automatic reports.</p></li>
</ol>
<p>If you are writing some code from scratch for <cite>litebird_sim</cite>, it is
advisable to implement this approach and split it into a low-level
part that performs all the calculations, and a high-level part that
takes its data using the <a class="reference internal" href="simulations.html#litebird_sim.simulations.Simulation" title="litebird_sim.simulations.Simulation"><code class="xref py py-class docutils literal notranslate"><span class="pre">Simulation</span></code></a> class. In this way, the
low-level part can be called directly from the terminal without the
hassle to create a <a class="reference internal" href="simulations.html#litebird_sim.simulations.Simulation" title="litebird_sim.simulations.Simulation"><code class="xref py py-class docutils literal notranslate"><span class="pre">Simulation</span></code></a> object, which is easier for
debugging.</p>
<p>Finally, you should add some automatic tests and put them in the
folder <code class="docutils literal notranslate"><span class="pre">litebird_sim/test</span></code> in files whose name matches the pattern
<code class="docutils literal notranslate"><span class="pre">test_*.py</span></code>: in this way, they will be called automatically after
every commit and will ensure that your code works as expected on the
target machine.</p>
</section>
<section id="a-practical-example">
<h2>A practical example<a class="headerlink" href="#a-practical-example" title="Link to this heading">#</a></h2>
<p>Imagine you have developed a robust noise generation module, which has
the following structure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># File mynoisegen.py</span>

<span class="k">class</span> <span class="nc">NoiseGenerator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>

    <span class="k">def</span> <span class="nf">generate_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Generate some noise</span>
        <span class="k">return</span> <span class="o">...</span>
</pre></div>
</div>
<p>To integrate this module in the LiteBIRD Simulation Framework, you
might want to write a wrapper class to <code class="docutils literal notranslate"><span class="pre">NoiseGenerator</span></code> that has an
interface of this kind:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">litebird_sim</span> <span class="k">as</span> <span class="nn">lbs</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mynoisegen</span>   <span class="c1"># This is the library we&#39;re integrating</span>

<span class="k">class</span> <span class="nc">MyWrapper</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">:</span> <span class="n">lbs</span><span class="o">.</span><span class="n">Simulation</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span> <span class="o">=</span> <span class="n">sim</span>

        <span class="c1"># To decide which seed to pass to &quot;NoiseGenerator&quot;,</span>
        <span class="c1"># take advantage of the &quot;sim&quot; object. Here we</span>
        <span class="c1"># assume to load it using the &quot;seed&quot; key in a</span>
        <span class="c1"># section named &quot;noise&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;noise&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;seed&quot;</span><span class="p">,</span> <span class="mi">1234</span><span class="p">)</span>

        <span class="c1"># Initialize your code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generator</span> <span class="o">=</span> <span class="n">mynoisegen</span><span class="o">.</span><span class="n">NoiseGenerator</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Call the function doing the *real* work</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">generate_noise</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">append_to_report</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        # Noise generation</span>

<span class="s2">        The noise generator produced </span><span class="si">{num_of_points}</span><span class="s2"> points,</span>
<span class="s2">        with an average </span><span class="si">{avg}</span><span class="s2"> and a standard deviation </span><span class="si">{sd}</span><span class="s2">.</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="n">num_of_points</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">),</span>
            <span class="n">avg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">),</span>
            <span class="n">sd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Now use &quot;self.noise&quot; somehow!</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>The interface implements the following features, which were missing in
the class <code class="docutils literal notranslate"><span class="pre">NoiseGenerator</span></code>:</p>
<ul>
<li><p>It loads the seed of the generator from the parameter file passed by
the user; the noise generator is likely to be used in a wider
pipeline, and this ensures that parameters to <code class="docutils literal notranslate"><span class="pre">NoiseGenerator</span></code> can
be kept with any other input parameter. The TOML parameter file
could be the following:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[noise]
seed = 6343

[scanning_strategy]
parameters = &quot;/releases/v1.3/Satellite/scanning_parameters/&quot;

[map_maker]
nside = 512
</pre></div>
</div>
<p>The code above accesses the field <code class="docutils literal notranslate"><span class="pre">sim.parameters</span></code>, which is a
Python dictionary containing the parsed content of the TOML file;
the call to the standard <cite>get</cite> method ensures that a default
value (1234) is used if parameter <code class="docutils literal notranslate"><span class="pre">seed</span></code> is not found in the TOML
file, but in the example above it would retrieve the number
<code class="docutils literal notranslate"><span class="pre">6343</span></code>. Note that the wrapper class does not need to deal with the
other sections in the file (<code class="docutils literal notranslate"><span class="pre">scanning_strategy</span></code>, <code class="docutils literal notranslate"><span class="pre">map_maker</span></code>):
they are handled by other modules in the pipeline. See
<a class="reference internal" href="simulations.html#parameter-files"><span class="std std-ref">Parameter files</span></a>.</p>
</li>
<li><p>It produces a section in the report output by the framework, which
contains some statistics about the generated noise (number of
samples, average, standard deviation). See <a class="reference internal" href="simulations.html#report-generation"><span class="std std-ref">Generation of reports</span></a>.</p></li>
</ul>
<p>Finally, we must add some tests. If the <code class="docutils literal notranslate"><span class="pre">NoiseGenerator</span></code> class is
expected to produce zero-mean output, then you might check that this
is indeed the case:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save this in file litebird_sim/test/test_noise_generator.py</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">litebird_sim</span> <span class="k">as</span> <span class="nn">lbs</span>

<span class="k">def</span> <span class="nf">test_noise_generator</span><span class="p">():</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">lbs</span><span class="o">.</span><span class="n">Simulation</span><span class="p">(</span><span class="n">random_seed</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>
    <span class="n">noisegen</span> <span class="o">=</span> <span class="n">MyWrapper</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
    <span class="n">noisegen</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># Of course, in real-life codes you would implement a</span>
    <span class="c1"># much more robust check here…</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">noisegen</span><span class="o">.</span><span class="n">noise</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">1e-5</span>
</pre></div>
</div>
</section>
<section id="checklist">
<h2>Checklist<a class="headerlink" href="#checklist" title="Link to this heading">#</a></h2>
<p>Here we list what any developer should check before integrating their
codes in the LiteBIRD Simulation Framework:</p>
<ol class="arabic">
<li><p>You must not leave sensitive information in the code (e.g.,
hardcoded noise levels): anything related to a quantitative
description of the instrument should be loaded from parameter files
or from the Instrument Model database. The best way to do this is
to delegate the loading of input parameters in a wrapper class that
uses a <a class="reference internal" href="simulations.html#litebird_sim.simulations.Simulation" title="litebird_sim.simulations.Simulation"><code class="xref py py-class docutils literal notranslate"><span class="pre">Simulation</span></code></a> object (see above).</p></li>
<li><p>All the <em>public</em> functions should be documented, either using
docstrings or other tools. You can put most of your effort in
documenting the wrapper class (in the example above,
<code class="docutils literal notranslate"><span class="pre">MyWrapper</span></code>), as this is the public interface most of the people
will use. Prefer the
<a class="reference external" href="https://sphinxcontrib-napoleon.readthedocs.io/en/latest/example_numpy.html">numpy sphinx syntax</a>.</p></li>
<li><p>All the measurement units should be stated clearly, possibly in
parameter/variable/function names. Consider the following
function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calc_sensitivity</span><span class="p">(</span><span class="n">t_ant</span><span class="p">):</span>
    <span class="c1"># Some very complex calculation comes here</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">t_ant</span><span class="p">,</span> <span class="n">whatever</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>The prototype does not help the user to understand what kind of
measurement units should be used for <code class="docutils literal notranslate"><span class="pre">t_ant</span></code>, nor what is the
measurement unit of the value returned by the function. The
following is much better:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calc_sensitivity_k_sqr_s</span><span class="p">(</span><span class="n">t_ant_k</span><span class="p">):</span>
    <span class="c1"># The same calculations as above</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">t_ant_k</span><span class="p">,</span> <span class="n">whatever</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>The second definition clarifies that the antenna temperature must
be specified in Kelvin, and that the result is in K⋅√s.</p>
</li>
<li><p>If you want to produce logging message, rely on the <a class="reference external" href="https://docs.python.org/3/library/logging.html">logging
library</a> in the
Python standard library.</p></li>
<li><p>You <strong>must</strong> format your code using <a class="reference external" href="https://github.com/astral-sh/ruff/">ruff</a>. If you fail to do so,
your code cannot be merged in the framework, as we automatically
check its conformance every time a new pull request is opened.</p></li>
<li><p>Similarly, your code must pass all the tests run by <cite>ruff check</cite>.</p></li>
<li><p>Always implement some tests!</p></li>
<li><p>If you are unsure about your python coding practices, the <a class="reference external" href="https://github.com/google/styleguide/blob/gh-pages/pyguide.md">Google
style guide</a>
is a good resource. See also our <a class="reference external" href="https://github.com/litebird/litebird_sim/blob/master/CONTRIBUTING.md">CONTRIBUTING file</a></p></li>
</ol>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="mpi.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Multithreading and MPI</p>
      </div>
    </a>
    <a class="right-next"
       href="part3.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Basic simulation modules</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-kind-of-codes-can-be-integrated">What kind of codes can be integrated</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-integrate-codes">How to integrate codes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-practical-example">A practical example</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#checklist">Checklist</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="_sources/integrating.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2020, The LiteBIRD Simulation Team.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.0.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>